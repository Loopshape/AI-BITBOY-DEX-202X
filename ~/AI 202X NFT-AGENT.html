<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AI Unified Tool v2.0.0 — Neon GUI + DEX</title>
<style>
/* ================== FULL CSS RESET + ADAPTER ================== */
html, body, div, span, applet, object, iframe,
h1,h2,h3,h4,h5,h6, p, blockquote, pre,
a, abbr, acronym, address, big, cite, code,
del, dfn, em, img, ins, kbd, q, s, samp,
small, strike, strong, sub, sup, tt, var,
b, u, i, center,
dl, dt, dd, ol, ul, li,
fieldset, form, label, legend,
table, caption, tbody, tfoot, thead, tr, th, td,
article, aside, canvas, details, embed,
figure, figcaption, footer, header, hgroup,
menu, nav, output, ruby, section, summary,
time, mark, audio, video {
  margin: 0; padding: 0; border: 0; font: inherit; vertical-align: baseline;
}
article, aside, details, figcaption, figure,
footer, header, hgroup, menu, nav, section { display: block; }
body {
  line-height: 1; min-height:100vh; overflow-x:hidden;
  background: #1a0a0f;
  font-family: 'SF Mono','Monaco','Inconsolata','Roboto Mono', monospace;
}
ol, ul { list-style: none; }
a { text-decoration: none; color: inherit; }
table { border-collapse: collapse; border-spacing: 0; }
button, input, select, textarea {
  font-family: inherit; font-size: inherit;
  background: none; border: none; outline: none; color: inherit;
  -webkit-tap-highlight-color: transparent;
}
img, video, canvas { display: block; max-width:100%; height:auto; }
* { box-sizing: border-box; }
/* ================== GLOBAL THEME OVERRIDES ================== */
:root {
  --color-neon-yellow: #ffff33;
  --color-neon-green: #00ff00;
  --color-neon-blue: #00ccff;
  --color-teal: #00ffcc;
  --color-neon-red: #ff3300;
  --color-paragraph: #ffffff;
  --color-bg-1: #1a0a0f;
  --color-bg-2: #0a1a2f;
  --color-bg-3: #2f0a1a;
  --color-background-gradient: linear-gradient(135deg, var(--color-bg-1), var(--color-bg-2), var(--color-bg-3));
  --font-glow: 0 0 6px var(--color-neon-yellow), 0 0 10px var(--color-neon-yellow);
  --panel-bg: rgba(0,0,0,0.7);
  --panel-border: #00ffcc;
  --panel-shadow: 0 0 25px #00ffcc33, inset 0 0 25px #00ffcc11;
}
body {
  background: var(--color-background-gradient);
  color: var(--color-paragraph);
}
h1,h2,h3,h4,h5,h6 { color: var(--color-neon-yellow); text-shadow: var(--font-glow); }
p { color: var(--color-paragraph); line-height:1.5; text-shadow:0 0 3px #ffffff33; }
ul li, ol li { color: var(--color-neon-yellow); text-shadow:0 0 4px #ffff33; }
a { color: var(--color-neon-blue); text-shadow:0 0 6px #00ccff; }
button { cursor:pointer; border-radius:10px; background: rgba(0,255,204,0.1); padding:10px 14px; color:#00ffcc; box-shadow:0 0 8px #00ffcc; transition: all 0.2s ease; border:1px solid #00ffcc55; }
button:hover { background: rgba(0,255,204,0.25); box-shadow:0 0 14px #00ffcc; }
input, textarea, select {
  background: rgba(0,0,0,0.35); border:1px solid #00ffcc; padding:8px 12px; color:#00ffcc; border-radius:8px; outline:none; transition:0.2s;
}
input:focus, textarea:focus, select:focus { border-color:#ffff33; box-shadow:0 0 8px #ffff33; }
canvas.fullscreen-adapter { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; }
.parallax-layer { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; transform-style: preserve-3d; }
/* Smooth scrolling and transitions */
* { scroll-behavior: smooth; transition: all 0.2s ease-in-out; }
/* ======= Top Navbar (UI at top) ======= */
.navbar {
  position: sticky; top: 0; left: 0; right: 0; z-index: 1000;
  background: linear-gradient(180deg, rgba(0,0,0,0.75), rgba(0,0,0,0.35));
  backdrop-filter: blur(6px);
  border-bottom: 2px solid var(--panel-border);
  box-shadow: 0 10px 40px #00ffcc22;
}
.navbar .inner {
  display: flex; align-items: center; gap: 10px; padding: 12px 16px; flex-wrap: wrap;
}
.brand {
  display:flex; align-items:center; gap:10px; padding-right:6px; margin-right:10px;
  border-right:1px dashed #00ffcc55;
}
.brand .dot { width:10px; height:10px; border-radius:50%; background:#00ffcc; box-shadow:0 0 12px #00ffcc; }
.brand h1 { font-size: 18px; color: var(--color-neon-yellow); }
.toolbar { display:flex; gap: 8px; align-items:center; flex: 1; flex-wrap: wrap; }
.toolbar input[type="text"] { min-width: 260px; }
.toolbar .group { display:flex; gap:8px; align-items:center; }
.tabbar {
  display:flex; gap: 6px; padding: 8px 10px; border-top:1px dashed #00ffcc44;
  background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0));
}
.tabbar button { padding:8px 10px; font-weight:600; }
.tabbar button.active { background: rgba(255,255,51,0.2); color:#ffff66; border-color:#ffff66; box-shadow:0 0 12px #ffff66; }
/* ======= Main Content ======= */
.main {
  position: relative;
  width: 100%;
  min-height: calc(100vh - 100px);
  padding: 18px;
}
.grid {
  display:grid;
  grid-template-columns: 1.1fr 1fr;
  gap: 16px;
}
.panel {
  border-radius:16px; padding:14px; background:var(--panel-bg);
  border:2px solid var(--panel-border); color:#00ffcc; text-shadow:0 0 5px #00ffcc;
  box-shadow: var(--panel-shadow);
}
.panel h3 { margin-bottom:10px; }
.row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.row > * { flex: 1; min-width: 180px; }
.kv { display:grid; grid-template-columns: 160px 1fr; gap:8px; align-items:center; }
.sep { height:1px; background: linear-gradient(90deg, transparent, #00ffcc55, transparent); margin: 10px 0; }
textarea.log {
  height:180px; width:100%; resize:vertical; background:rgba(0,0,0,0.6);
  border:1px dashed #00ffcc88; border-radius:12px; padding:10px; color:#aaffff;
}
.badge { border:1px solid #00ffcc88; padding:4px 8px; border-radius:999px; font-size:12px; }
.small { font-size: 12px; opacity: 0.9; }
.right { justify-content: flex-end; }
footer {
  text-align:center; padding: 20px 10px; font-size: 12px; color:#88ffee;
  opacity:0.8;
}
/* ======= DEX Specific ======= */
.dex-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.table-like { width:100%; border:1px dashed #00ffcc55; border-radius:12px; padding:10px; }
.table-like h4 { margin-bottom: 8px; }
.table-like .row { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:6px; padding:4px 0; }
.table-like .row:nth-child(odd) { background: rgba(0,255,204,0.05); border-radius: 6px; padding:6px; }
/* Mobile */
@media (max-width: 1000px) {
  .grid { grid-template-columns: 1fr; }
  .dex-grid { grid-template-columns: 1fr; }
  .toolbar input[type="text"] { min-width: 180px; }
}
</style>
</head>
<body>
  <header class="navbar">
    <div class="inner">
      <div class="brand">
        <div class="dot" id="statusDot" title="status"></div>
        <h1>AI Unified Tool v2.0.0 — Neon</h1>
      </div>

      <div class="toolbar">
        <div class="group">
          <label class="badge">AI Endpoint</label>
          <input id="aiEndpoint" type="text" placeholder="http://localhost:11434/api/generate"/>
        </div>
        <div class="group">
          <label class="badge">Model</label>
          <input id="aiModel" type="text" placeholder="gemma3:1b" value="gemma3:1b"/>
        </div>
        <div class="group">
          <label class="badge">Temp</label>
          <input id="aiTemp" type="number" min="0.1" max="2.0" step="0.1" value="0.7"/>
        </div>
        <div class="group">
          <label class="badge">Max Tokens</label>
          <input id="aiMaxTokens" type="number" min="1" max="10000" step="1" value="1000"/>
        </div>
        <div class="group">
          <button id="saveCfg">Save</button>
          <button id="testAI">Test AI</button>
        </div>
        <div class="group right">
          <label class="badge">RPC</label>
          <input id="rpcUrl" type="text" placeholder="https://mainnet.infura.io/v3/KEY or http://localhost:8545"/>
          <button id="saveRPC">Save RPC</button>
        </div>
      </div>

      <div class="tabbar">
        <button class="tabBtn active" data-tab="chat">Chat</button>
        <button class="tabBtn" data-tab="crypto">Crypto Ops</button>
        <button class="tabBtn" data-tab="system">System</button>
        <button class="tabBtn" data-tab="tuning">Tuning</button>
        <button class="tabBtn" data-tab="dex">DEX</button>
        <button class="tabBtn" data-tab="logs">Logs</button>
      </div>
    </div>
  </header>

  <main class="main">
    <section id="tab-chat" class="grid panel">
      <div>
        <h3>AI Chat</h3>
        <div class="sep"></div>
        <div class="row">
          <input id="chatInput" type="text" placeholder="Type a prompt…"/>
          <button id="sendChat">Send</button>
          <button id="resetChat">Reset</button>
        </div>
        <div class="sep"></div>
        <textarea id="chatLog" class="log" placeholder="AI output…"></textarea>
      </div>
      <div>
        <h3>Quick Prompts</h3>
        <div class="sep"></div>
        <div class="row">
          <button class="q" data-q="Summarize: latest trends in DeFi risk management.">DeFi Risk</button>
          <button class="q" data-q="Explain like I'm five: what is a Merkle tree?">Merkle ELI5</button>
          <button class="q" data-q="Draft a clear todo checklist for optimizing a bash script.">Bash Optimize</button>
          <button class="q" data-q="Create a concise design spec for a neon-themed UI dashboard.">Neon Spec</button>
        </div>
      </div>
    </section>

    <section id="tab-crypto" class="panel" style="display:none;">
      <h3>Cryptographic Operations</h3>
      <div class="sep"></div>
      <div class="grid">
        <div class="panel">
          <h4>Handshake (SHA-256)</h4>
          <div class="kv">
            <label>Message</label>
            <input id="hsMsg" type="text" placeholder="secure message"/>
            <label>Handshake ID</label>
            <input id="hsId" type="text" placeholder="handshake_1234"/>
          </div>
          <div class="row right" style="margin-top:10px;"><button id="doHandshake">Generate</button></div>
          <div class="sep"></div>
          <textarea id="hsOut" class="log" placeholder="Handshake result…"></textarea>
        </div>
        <div class="panel">
          <h4>Entropy</h4>
          <div class="kv">
            <label>Length (1-1024)</label>
            <input id="entLen" type="number" min="1" max="1024" value="64"/>
          </div>
          <div class="row right" style="margin-top:10px;"><button id="genEntropy">Generate</button></div>
          <div class="sep"></div>
          <textarea id="entOut" class="log" placeholder="Entropy hex…"></textarea>
        </div>
      </div>
    </section>

    <section id="tab-system" class="panel" style="display:none;">
      <h3>System Status</h3>
      <div class="sep"></div>
      <div class="grid">
        <div class="panel">
          <h4>Environment</h4>
          <div class="table-like">
            <div class="row"><div>User Agent</div><div id="ua"></div><div class="small">navigator.userAgent</div></div>
            <div class="row"><div>Platform</div><div id="plat"></div><div class="small">navigator.platform</div></div>
            <div class="row"><div>Memory (approx)</div><div id="mem"></div><div class="small">navigator.deviceMemory</div></div>
            <div class="row"><div>Language</div><div id="lang"></div><div class="small">navigator.language</div></div>
            <div class="row"><div>Online</div><div id="onl"></div><div class="small">navigator.onLine</div></div>
          </div>
        </div>
        <div class="panel">
          <h4>AI Config</h4>
          <div class="table-like">
            <div class="row"><div>Model</div><div id="sysModel"></div><div class="small">AI_MODEL</div></div>
            <div class="row"><div>Temperature</div><div id="sysTemp"></div><div class="small">AI_TEMPERATURE</div></div>
            <div class="row"><div>Max Tokens</div><div id="sysMaxTokens"></div><div class="small">AI_MAX_TOKENS</div></div>
            <div class="row"><div>Timeout</div><div id="sysTimeout"></div><div class="small">AI_TIMEOUT</div></div>
          </div>
          <div class="sep"></div>
          <button id="probeOllama">Probe Endpoint (Ollama Tags)</button>
          <textarea id="probeOut" class="log" placeholder="Probe output…"></textarea>
        </div>
      </div>
    </section>

    <section id="tab-tuning" class="panel" style="display:none;">
      <h3>Tuning Parameters</h3>
      <div class="sep"></div>
      <div class="grid">
        <div class="panel">
          <h4>Adjust</h4>
          <div class="kv">
            <label>Temperature</label><input id="tnTemp" type="number" min="0.1" max="2.0" step="0.1" value="0.7"/>
            <label>Max Tokens</label><input id="tnMaxTok" type="number" min="1" max="10000" step="1" value="1000"/>
            <label>Timeout (s)</label><input id="tnTimeout" type="number" min="1" max="300" step="1" value="30"/>
          </div>
          <div class="row right" style="margin-top:10px;"><button id="applyTuning">Apply</button></div>
        </div>
        <div class="panel">
          <h4>Guidance</h4>
          <p class="small">
            • 0.1–0.5: deterministic<br/>
            • 0.5–0.8: balanced<br/>
            • 0.8–1.2: creative<br/>
          </p>
        </div>
      </div>
    </section>

    <section id="tab-dex" class="panel" style="display:none;">
      <h3>DEX Module (BITBOY-AI-DEX style — single-file)</h3>
      <div class="sep"></div>

      <div class="grid">
        <div class="panel">
          <h4>Wallet</h4>
          <div class="row">
            <button id="connectWallet">Connect Wallet</button>
            <span id="walletAddr" class="badge">Not connected</span>
            <span id="walletChain" class="badge">Chain: —</span>
          </div>
          <div class="sep"></div>
          <h4>ERC-20 Balance</h4>
          <div class="kv">
            <label>Token Address</label><input id="erc20Addr" type="text" placeholder="0x…"/>
            <label>Account</label><input id="erc20Acct" type="text" placeholder="defaults to connected"/>
          </div>
          <div class="row right" style="margin-top:10px;"><button id="loadBalance">Load</button></div>
          <div class="sep"></div>
          <div class="table-like">
            <div class="row"><div>Symbol</div><div id="erc20Symbol">—</div><div class="small">symbol()</div></div>
            <div class="row"><div>Decimals</div><div id="erc20Decimals">—</div><div class="small">decimals()</div></div>
            <div class="row"><div>Balance</div><div id="erc20Balance">—</div><div class="small">balanceOf()</div></div>
          </div>
        </div>

        <div class="panel">
          <h4>Build Calldata</h4>
          <div class="kv">
            <label>Router (UniswapV2)</label><input id="routerAddr" type="text" placeholder="0x…"/>
            <label>Path (comma addresses)</label><input id="swapPath" type="text" placeholder="tokenIn,tokenOut"/>
            <label>Amount In (wei)</label><input id="amountIn" type="text" placeholder="e.g. 1000000000000000000"/>
            <label>Min Out (wei)</label><input id="amountOutMin" type="text" placeholder="0 for demo"/>
            <label>Recipient</label><input id="recipient" type="text" placeholder="0x…"/>
            <label>Deadline (unix)</label><input id="deadline" type="text" placeholder="e.g. 4102444800 (2100-01-01)"/>
          </div>
          <div class="row right" style="margin-top:10px;">
            <button id="buildApprove">Build Approve</button>
            <button id="buildSwap">Build Swap</button>
          </div>
          <div class="sep"></div>
          <textarea id="txData" class="log" placeholder="Transaction data hex…"></textarea>
          <div class="row right" style="margin-top:10px;">
            <button id="sendTx">Send via Wallet</button>
          </div>
        </div>
      </div>

      <div class="sep"></div>
      <div class="dex-grid">
        <div class="panel">
          <h4>Mock Order Book</h4>
          <div id="orderBook" class="table-like"></div>
        </div>
        <div class="panel">
          <h4>Signals</h4>
          <textarea id="signals" class="log" placeholder="AI trading signals or notes…"></textarea>
          <div class="row right" style="margin-top:10px;">
            <button id="genSignals">AI: Generate Signals</button>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-logs" class="panel" style="display:none;">
      <h3>Logs</h3>
      <div class="sep"></div>
      <textarea id="appLog" class="log" placeholder="App logs…"></textarea>
      <div class="row right" style="margin-top:10px;">
        <button id="clearLogs">Clear</button>
        <button id="downloadHtml">Export This HTML</button>
      </div>
    </section>
  </main>

  <footer>
    <span class="small">© 2025 AI Unified Tool — single-file build. UI pinned to top. No external deps.</span>
  </footer>

<script>
// ================== DOM ADAPTER + PARALLAX ==================
function setupDOMAdapter(container){
  container.style.position = 'relative';
  container.style.width = '100%';
  container.style.minHeight = '100vh';
  container.style.overflow = 'hidden';

  const layers = [];
  for(let i=0;i<8;i++){
    const layer = document.createElement('div');
    layer.className = 'parallax-layer';
    layer.style.zIndex = i;
    layer.style.opacity = 0.05 + i*0.04;
    layer.style.background = i % 2
      ? 'radial-gradient(600px 200px at 20% 20%, #00ffcc22, transparent)'
      : 'radial-gradient(600px 200px at 80% 60%, #ffff3322, transparent)';
    container.appendChild(layer);
    layers.push(layer);
  }
  window.addEventListener('mousemove', (e)=>{
    const cx = window.innerWidth/2, cy = window.innerHeight/2;
    const dx = (e.clientX - cx)/cx, dy = (e.clientY - cy)/cy;
    layers.forEach((l,idx)=>{
      const depth = (idx+1)*2;
      l.style.transform = \`translate3d(\${-dx*depth}px, \${-dy*depth}px, 0)\`;
    });
  });
  return layers;
}
setupDOMAdapter(document.body);

// ================== UTILITIES ==================
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function logLine(msg){ const el = $('#appLog'); el.value += \`[\${new Date().toISOString()}] \${msg}\\n\`; el.scrollTop = el.scrollHeight; }
function setStatus(ok){ const d = $('#statusDot'); d.style.background = ok ? '#00ff88' : '#ff5533'; d.style.boxShadow = ok ? '0 0 16px #00ff88' : '0 0 16px #ff5533'; }
function saveLocal(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
function loadLocal(key,def=null){ try{ const v = JSON.parse(localStorage.getItem(key)); return v ?? def; }catch(_){ return def; } }
function toHex(num){ if (typeof num === 'bigint') return '0x'+num.toString(16); if (typeof num==='number') return '0x'+num.toString(16); if (typeof num==='string' && num.startsWith('0x')) return num; return '0x'+BigInt(num).toString(16); }
function strip0x(h){ return (h||'').replace(/^0x/,''); }
function pad32(hex){ hex = strip0x(hex); return hex.padStart(64, '0'); }
function isAddress(a){ return /^0x[a-fA-F0-9]{40}$/.test(a||''); }
function encAddress(a){ return pad32(strip0x(a)); }
function encUint(v){ return pad32(strip0x(toHex(BigInt(v)))); }
function encBytesDynamic(bytesHex){
  // dynamic bytes encoding: [offset][length][data padded]
  const data = strip0x(bytesHex);
  const len = (data.length/2)|0;
  const lenWord = pad32(len.toString(16));
  const paddedLen = Math.ceil(len/32)*32;
  const pad = ''.padEnd((paddedLen - len)*2, '0');
  return { head: null, tail: lenWord + data + pad };
}
function encAddressArrayDynamic(arr){
  // address[] dynamic: head placeholder + tail with length and items
  const lengthWord = pad32(arr.length.toString(16));
  const items = arr.map(encAddress).join('');
  return { head: null, tail: lengthWord + items };
}
// function selectors
const SIG = {
  approve: '0x095ea7b3',
  swapExactTokensForTokens: '0x38ed1739',
  balanceOf: '0x70a08231',
  decimals: '0x313ce567',
  symbol: '0x95d89b41'
};
function buildApproveData(spender, amount){
  if(!isAddress(spender)) throw new Error('Invalid spender address');
  return SIG.approve + encAddress(spender) + encUint(amount);
}
function buildSwapExactTokensForTokens(amountIn, amountOutMin, path, to, deadline){
  if(!isAddress(to)) throw new Error('Invalid recipient address');
  if(!Array.isArray(path) || path.length<2 || !path.every(isAddress)) throw new Error('Invalid path');
  // params: amountIn, amountOutMin, path(address[] dynamic), to, deadline
  // head: [aIn][aOutMin][offset(path)][to][deadline]
  const headA = encUint(amountIn);
  const headB = encUint(amountOutMin);
  const headD = encAddress(to);
  const headE = encUint(deadline);
  // dynamic path tail
  const pathDyn = encAddressArrayDynamic(path);
  // offset: head is 5 words => path is the 3rd argument (index 2), with two dynamic args before it? only one dynamic (path).
  // Head consists of 5 words. The offset to the dynamic data is 32 * number_of_head_words = 32*5 = 160 bytes => 0xA0
  const offsetPath = pad32((5*32).toString(16));
  const head = headA + headB + offsetPath + headD + headE;
  const tail = pathDyn.tail;
  return SIG.swapExactTokensForTokens + head + tail;
}
// JSON-RPC helper
async function rpcCall(method, params){
  const url = $('#rpcUrl').value.trim();
  if(!url){ throw new Error('RPC URL is empty'); }
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ jsonrpc:'2.0', id:1, method, params })
  });
  const j = await res.json();
  if(j.error) throw new Error(j.error.message || 'RPC Error');
  return j.result;
}
// Minimal ERC-20 calls
async function erc20Call(addr, data){
  const callObj = { to: addr, data };
  return await rpcCall('eth_call', [callObj, 'latest']);
}
function hexToString(hex){
  // attempt to read symbol(), which returns bytes32 or string; we try ascii from right
  hex = strip0x(hex);
  if (hex.length >= 64) {
    const bytes = hex.match(/.{1,2}/g).map(b=>parseInt(b,16));
    // trim zeros
    let end = bytes.length;
    while (end>0 && bytes[end-1]===0) end--;
    return String.fromCharCode(...bytes.slice(0,end)).replace(/[^\x20-\x7E]/g,'');
  }
  return '';
}
function formatUnits(valueHex, decimals){
  const v = BigInt(valueHex);
  const d = BigInt(decimals);
  const base = 10n**d;
  const whole = v / base;
  const frac = (v % base).toString().padStart(Number(d), '0').replace(/0+$/,'');
  return frac ? \`\${whole}.\${frac}\` : whole.toString();
}

// ================== TABS ==================
$$('.tabBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    $$('.tabBtn').forEach(b=>b.classList.toggle('active', b===btn));
    const tab = btn.dataset.tab;
    ['chat','crypto','system','tuning','dex','logs'].forEach(id=>{
      $('#tab-'+id).style.display = (id===tab) ? (id==='chat' ? 'grid' : 'block') : 'none';
    });
  });
});

// ================== CONFIG LOAD/SAVE ==================
function loadCfg(){
  $('#aiEndpoint').value = loadLocal('aiEndpoint','http://localhost:11434/api/generate');
  $('#aiModel').value = loadLocal('aiModel','gemma3:1b');
  $('#aiTemp').value = loadLocal('aiTemp',0.7);
  $('#aiMaxTokens').value = loadLocal('aiMaxTokens',1000);
  $('#rpcUrl').value = loadLocal('rpcUrl','');
  $('#tnTemp').value = $('#aiTemp').value;
  $('#tnMaxTok').value = $('#aiMaxTokens').value;
  $('#tnTimeout').value = loadLocal('aiTimeout',30);
  $('#sysModel').textContent = $('#aiModel').value;
  $('#sysTemp').textContent = $('#aiTemp').value;
  $('#sysMaxTokens').textContent = $('#aiMaxTokens').value;
  $('#sysTimeout').textContent = $('#tnTimeout').value + 's';
}
function saveCfg(){
  saveLocal('aiEndpoint', $('#aiEndpoint').value.trim());
  saveLocal('aiModel', $('#aiModel').value.trim());
  saveLocal('aiTemp', parseFloat($('#aiTemp').value));
  saveLocal('aiMaxTokens', parseInt($('#aiMaxTokens').value,10));
  saveLocal('rpcUrl', $('#rpcUrl').value.trim());
  saveLocal('aiTimeout', parseInt($('#tnTimeout').value,10));
  loadCfg();
  logLine('Configuration saved');
}
$('#saveCfg').addEventListener('click', saveCfg);
$('#saveRPC').addEventListener('click', saveCfg);
$('#applyTuning').addEventListener('click', ()=>{
  $('#aiTemp').value = $('#tnTemp').value;
  $('#aiMaxTokens').value = $('#tnMaxTok').value;
  saveCfg();
});

// ================== CHAT / AI ==================
async function callAI(prompt){
  const endpoint = $('#aiEndpoint').value.trim();
  const model = $('#aiModel').value.trim();
  const temp = parseFloat($('#aiTemp').value);
  const maxTokens = parseInt($('#aiMaxTokens').value,10);
  const timeout = (parseInt($('#tnTimeout').value,10)||30) * 1000;
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeout);

  // Try Ollama /api/generate streaming false
  const body = { model, prompt, options: { temperature: temp, num_predict: maxTokens } };
  try{
    const res = await fetch(endpoint, {
      method: 'POST',
      headers: { 'content-type':'application/json' },
      body: JSON.stringify(body),
      signal: ctrl.signal
    });
    clearTimeout(t);
    const txt = await res.text();
    // If endpoint streams JSON lines, try to parse; else fallback text
    if (txt.trim().startsWith('{') || txt.trim().startsWith('{"')) {
      // Attempt to detect streaming lines
      const lines = txt.trim().split('\\n').filter(Boolean);
      let acc = '';
      for(const ln of lines){
        try{
          const j = JSON.parse(ln);
          if (j.response) acc += j.response;
          else if (j.message && j.message.content) acc += j.message.content;
        }catch(_){ acc += ln + '\\n'; }
      }
      return acc || txt;
    }
    return txt;
  }catch(err){
    logLine('AI call failed, returning simulated output: '+err.message);
    return '[[Simulated response]] ' + prompt.slice(0,200);
  }
}
$('#sendChat').addEventListener('click', async ()=>{
  const prompt = $('#chatInput').value.trim();
  if(!prompt) return;
  setStatus(true);
  $('#chatLog').value += 'You: ' + prompt + '\\n';
  const out = await callAI(prompt);
  $('#chatLog').value += 'AI: ' + out + '\\n\\n';
  $('#chatInput').value='';
});
$('#resetChat').addEventListener('click', ()=>{ $('#chatLog').value=''; });
$$('.q').forEach(b=> b.addEventListener('click', ()=>{ $('#chatInput').value = b.dataset.q; }));
$('#testAI').addEventListener('click', async ()=>{
  const out = await callAI('Say: AI endpoint reachable.');
  logLine('AI test -> ' + out.replace(/\\s+/g,' ').slice(0,160) + '…');
});

// ================== CRYPTOGRAPHIC OPS ==================
$('#doHandshake').addEventListener('click', async ()=>{
  const msg = $('#hsMsg').value || 'message';
  const id = $('#hsId').value || ('handshake_'+Date.now());
  const ts = Math.floor(Date.now()/1000);
  const enc = new TextEncoder();
  const data = enc.encode(msg + ts + id);
  const hashBuf = await crypto.subtle.digest('SHA-256', data);
  const hashHex = Array.from(new Uint8Array(hashBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  $('#hsOut').value = [
    'Handshake ID: '+id,
    'Timestamp: '+ts,
    'Message: '+msg,
    'SHA256 Hash: '+hashHex,
    'Complete: ✓'
  ].join('\\n');
  logLine('Handshake generated: '+id);
});
$('#genEntropy').addEventListener('click', ()=>{
  const len = Math.min(1024, Math.max(1, parseInt($('#entLen').value,10)||64));
  const buf = new Uint8Array(len);
  crypto.getRandomValues(buf);
  const hex = Array.from(buf).map(b=>b.toString(16).padStart(2,'0')).join('');
  $('#entOut').value = hex;
  logLine('Entropy generated: '+len+' bytes');
});

// ================== SYSTEM ==================
function refreshSystem(){
  $('#ua').textContent = navigator.userAgent;
  $('#plat').textContent = navigator.platform;
  $('#mem').textContent = (navigator.deviceMemory? navigator.deviceMemory+' GB' : 'n/a');
  $('#lang').textContent = navigator.language;
  $('#onl').textContent = navigator.onLine ? 'online' : 'offline';
  $('#sysModel').textContent = $('#aiModel').value;
  $('#sysTemp').textContent = $('#aiTemp').value;
  $('#sysMaxTokens').textContent = $('#aiMaxTokens').value;
  $('#sysTimeout').textContent = ($('#tnTimeout').value||'30')+'s';
}
$('#probeOllama').addEventListener('click', async ()=>{
  const ep = $('#aiEndpoint').value.trim();
  const base = ep.replace(/\/api\/generate.*/,''); // try to derive base
  try{
    const res = await fetch(base + '/api/tags');
    const j = await res.json();
    $('#probeOut').value = JSON.stringify(j, null, 2);
    logLine('Probe success: /api/tags');
  }catch(err){
    $('#probeOut').value = 'Probe failed: ' + err.message;
    logLine('Probe failed: ' + err.message);
  }
});

// ================== DEX ==================
let connected = { account: null, chainId: null };
$('#connectWallet').addEventListener('click', async ()=>{
  if (!window.ethereum){ alert('No wallet (window.ethereum) found'); return; }
  try{
    const accs = await window.ethereum.request({ method:'eth_requestAccounts' });
    connected.account = accs[0];
    const chainId = await window.ethereum.request({ method:'eth_chainId' });
    connected.chainId = chainId;
    $('#walletAddr').textContent = connected.account;
    $('#walletChain').textContent = 'Chain: ' + chainId;
    if (!$('#recipient').value) $('#recipient').value = connected.account;
    logLine('Wallet connected: '+connected.account+' on '+chainId);
  }catch(err){
    alert('Wallet connect failed: ' + err.message);
  }
});
$('#loadBalance').addEventListener('click', async ()=>{
  const token = $('#erc20Addr').value.trim();
  if (!isAddress(token)) { alert('Invalid token address'); return; }
  let acct = $('#erc20Acct').value.trim();
  if (!acct && connected.account) acct = connected.account;
  if (!isAddress(acct)) { alert('Invalid account (or connect wallet)'); return; }
  try{
    // decimals
    const decHex = await erc20Call(token, SIG.decimals);
    const decimals = parseInt(strip0x(decHex),16);
    $('#erc20Decimals').textContent = String(decimals);
    // symbol
    const symHex = await erc20Call(token, SIG.symbol);
    const symbol = hexToString(symHex) || '(?)';
    $('#erc20Symbol').textContent = symbol;
    // balanceOf
    const balHex = await erc20Call(token, SIG.balanceOf + encAddress(acct));
    const balance = formatUnits(BigInt(balHex), decimals);
    $('#erc20Balance').textContent = balance + ' ' + symbol;
    logLine('Loaded balance for '+acct+' @ '+token);
  }catch(err){
    alert('Balance query failed: '+err.message);
    logLine('Balance query failed: '+err.message);
  }
});
$('#buildApprove').addEventListener('click', ()=>{
  try{
    const token = $('#erc20Addr').value.trim();
    const router = $('#routerAddr').value.trim();
    if (!isAddress(token) || !isAddress(router)) { alert('Token or router invalid'); return; }
    const amount = $('#amountIn').value.trim() || '0';
    const data = buildApproveData(router, amount);
    $('#txData').value = JSON.stringify({ to: token, data }, null, 2);
    logLine('Built approve calldata');
  }catch(err){ alert(err.message); }
});
$('#buildSwap').addEventListener('click', ()=>{
  try{
    const router = $('#routerAddr').value.trim();
    const path = $('#swapPath').value.split(',').map(s=>s.trim()).filter(Boolean);
    const amountIn = $('#amountIn').value.trim() || '0';
    const amountOutMin = $('#amountOutMin').value.trim() || '0';
    const to = $('#recipient').value.trim();
    const deadline = $('#deadline').value.trim() || (Math.floor(Date.now()/1000)+3600).toString();
    const data = buildSwapExactTokensForTokens(amountIn, amountOutMin, path, to, deadline);
    $('#txData').value = JSON.stringify({ to: router, data, value: '0x0' }, null, 2);
    logLine('Built swap calldata');
  }catch(err){ alert(err.message); }
});
$('#sendTx').addEventListener('click', async ()=>{
  if (!window.ethereum){ alert('No wallet found'); return; }
  try{
    const tx = JSON.parse($('#txData').value || '{}');
    if (!tx.to || !tx.data){ alert('Build tx data first'); return; }
    if (!connected.account){ await $('#connectWallet').click(); }
    tx.from = connected.account;
    const hash = await window.ethereum.request({ method:'eth_sendTransaction', params:[tx] });
    alert('Tx sent: ' + hash);
    logLine('Tx sent: ' + hash);
  }catch(err){ alert('Send failed: '+err.message); logLine('Send failed: '+err.message); }
});

// Mock order book (visual demo)
function refreshOrderBook(){
  const ob = $('#orderBook');
  ob.innerHTML = '<h4>Book (mock)</h4>';
  const table = document.createElement('div');
  table.className='table-like';
  for(let i=0;i<12;i++){
    const price = (1000 + Math.random()*50*(i%2?-1:1)).toFixed(2);
    const size = (Math.random()*5).toFixed(3);
    const side = i%2 ? 'ASK' : 'BID';
    const row = document.createElement('div');
    row.className='row';
    row.innerHTML = \`<div>\${side}</div><div>\${price}</div><div>\${size}</div>\`;
    table.appendChild(row);
  }
  ob.appendChild(table);
}

// Signals via AI
$('#genSignals').addEventListener('click', async ()=>{
  const out = await callAI('Generate 3 concise token trading signals with entry/exit and brief reasoning. Format as bullets.');
  $('#signals').value = out;
});

// Logs
$('#clearLogs').addEventListener('click', ()=> $('#appLog').value='');
$('#downloadHtml').addEventListener('click', ()=>{
  const blob = new Blob([document.documentElement.outerHTML], { type:'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ai-unified-neon-DEX.html';
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
});

// Init
loadCfg();
refreshSystem();
setInterval(refreshOrderBook, 3500);
setStatus(true);
logLine('App ready');
</script>
</body>
</html>
